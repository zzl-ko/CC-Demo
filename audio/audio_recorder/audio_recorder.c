/************************************************************************************************************* 
* Copyright: (C)2019, All rights reserved.
* Version  : V1.0
* Author   : Kevin Zhou <zzl.ko@outlook.com>
* Date     : 2020.04.28
* Abstact  : None
* History  : Please check the end of this file.
*************************************************************************************************************/

/************************************** INCLUDE *************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <linux/soundcard.h>

/************************************** NAMESPACE ***********************************************************/
/************************************** CONST DEFINE ********************************************************/
/************************************** MACRO DEFINE ********************************************************/
#define VAR_STATIC

#define DEV_NAME   "/dev/dsp"

#define FMT8BITS   AFMT_S8_LE
#define FMT16BITS  AFMT_S16_LE
#define FMT8K      8000
#define FMT16K     16000
#define FMT22K     22000
#define FMT44K     44000
#define MONO       1
#define STERO      2

#define DEBUG_LOG()        printf("Time=[%s] FILE=[%s] LINE=[%d]\n",__TIME__,__FILE__,__LINE__);
#define ERR_EXIT(m)        (perror(m),exit(EXIT_FAILURE))

/************************************** EMUN DEFINE *********************************************************/
/************************************** TYPE DEFINE *********************************************************/

/************************************** GLOBAL VARIABLE DECLARE *********************************************/
/************************************** LOCAL VARIABLE DECLARE **********************************************/
int devfd = 0;

/************************************** EXTERN FUNCTION PROTOTYPE *******************************************/
/************************************** LOCAL FUNCTION PROTOTYPE ********************************************/

/************************************************************************************************************/
/*                                      LOCAL FUNCTION IMPLEMENT                                            */
/************************************************************************************************************/

/************************************************************************************************************/
/*                                      GLOBAL FUNCTION IMPLEMENT                                           */
/************************************************************************************************************/
/*************************************************************************************************************
* @Param[in]  : None
* @Param[out] : None
* @Return     : 成功返回1，失败返回0
* @Description: 打开音响设备
* @History    :
* -----------------------------------------------------------------------------------------------------------
* @Date        Version    Author        Modify 
* ----------------------------------------------------------------------------------------------------------- 
* 2020.04.28   V1.0       Kevin Zhou    Initial version create
*************************************************************************************************************/
int OpenSnd(void)
{
    if(devfd > 0) 
        close(devfd);
    devfd = open(DEV_NAME, O_RDWR);
    if(devfd < 0)
        return 0;
    return 1;
}

/*************************************************************************************************************
* @Param[in]  : None
* @Param[out] : None
* @Return     : 成功返回1，失败返回0
* @Description: 关闭声音设备
* @History    :
* -----------------------------------------------------------------------------------------------------------
* @Date        Version    Author        Modify 
* ----------------------------------------------------------------------------------------------------------- 
* 2020.04.28   V1.0       Kevin Zhou    Initial version create
*************************************************************************************************************/
int CloseSnd(void)
{
    close(devfd);
    devfd = 0;
    return 1;
}

/*************************************************************************************************************
* @Param[in]  : bits -- FMT8BITS(8bits), FMT16BITS(16bits)
* @Param[in]  : rate -- FMT8K(8000HZ), FMT16K(16000HZ), FMT22K(22000HZ), FMT44K(44000HZ)
* @Param[out] : None
* @Return     : 成功返回1，失败返回0
* @Description: 设置录制播放格式
* @History    :
* -----------------------------------------------------------------------------------------------------------
* @Date        Version    Author        Modify 
* ----------------------------------------------------------------------------------------------------------- 
* 2020.04.28   V1.0       Kevin Zhou    Initial version create
*************************************************************************************************************/
int SetFormat(int bits, int rate)
{
    int temp = bits;
    if(-1 == ioctl(devfd, SNDCTL_DSP_SETFMT, &temp)){
        printf("Set fmt to s16_little faile\r\n");
        return 0;
    }
 
    temp = rate;
    if(-1 == ioctl(devfd, SNDCTL_DSP_SPEED, &temp)){
        printf("Set speed to %d\r\n", rate);
        return 0;
    }
    return 1;
}

/*************************************************************************************************************
* @Param[in]  : channel -- MONO(单通道), STERO(双通道)
* @Param[out] : None
* @Return     : 成功返回1，失败返回0
* @Description: 设置声卡通道
* @History    :
* -----------------------------------------------------------------------------------------------------------
* @Date        Version    Author        Modify 
* ----------------------------------------------------------------------------------------------------------- 
* 2020.04.28   V1.0       Kevin Zhou    Initial version create
*************************************************************************************************************/
int SetChannel(int channel)
{
    int temp = channel;
    if(-1 == ioctl(devfd, SNDCTL_DSP_CHANNELS, &temp)){
        printf("Set Audio Channel faile\r\n");
        return 0;
    }
    return 1;
}

/*************************************************************************************************************
* @Param[in]  : siz -- 缓存区大小
* @Param[out] : buf -- 存放数据的buf
* @Return     : 返回读取的字节数
* @Description: 录制
* @History    :
* -----------------------------------------------------------------------------------------------------------
* @Date        Version    Author        Modify 
* ----------------------------------------------------------------------------------------------------------- 
* 2020.04.28   V1.0       Kevin Zhou    Initial version create
*************************************************************************************************************/
int Record(int siz, char *buf)
{
    return read(devfd, buf, siz);
}

/*************************************************************************************************************
* @Param[in]  : siz -- 缓存区大小
* @Param[in]  : buf -- 存放数据的buf
* @Return     : 返回写入的字节数
* @Description: 播放
* @History    :
* -----------------------------------------------------------------------------------------------------------
* @Date        Version    Author        Modify 
* ----------------------------------------------------------------------------------------------------------- 
* 2020.04.28   V1.0       Kevin Zhou    Initial version create
*************************************************************************************************************/
int Play(int siz, char *buf)
{
	return write(devfd, buf, siz);
}

/*--------------------------------------------- Split Line -------------------------------------------------*/

int main(int argc, char const *argv[])
{
    char *buf;
    int dwSize;

    if(!OpenSnd()){//打开声音设备
        printf("Open sound device error!＼＼n");
        exit(-1);
    }

    SetFormat(FMT16BITS, FMT8K);
    SetChannel(MONO);

    buf = (char *)malloc(320);
    if(buf == NULL) exit(-1);
 
    int i;
    printf("begin...\n");
    for(i = 0; i <1000; i++){
        dwSize = Record(640, buf); //录音
        dwSize = Play(dwSize,buf); //播放
    }
    printf("close...\n");
    CloseSnd();

    return 0;
}

/* Complie: gcc audio_recorder.c -O2 -o audio_recorder
   Execute: ./audio_recorder
 */

/*************************************************************************************************************
* Date         Version    Author        Abstact
*------------------------------------------------------------------------------------------------------------
* 2019-04-28   V1.0       Kevin Zhou    Initial version create
*============================================================================================================
* ref: https://blog.csdn.net/gs1069405343/article/details/50471760
*************************************************************************************************************/
